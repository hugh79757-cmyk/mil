#!/usr/bin/env python3
"""ë¸”ë¡œê·¸ ì½˜í…ì¸  ìƒì„±ê¸°"""

import logging
from datetime import datetime

logger = logging.getLogger(__name__)


class ContentGenerator:
    """ì „ìŸì‚¬ + ë¬´ê¸° + íˆ¬ì ìœµí•© ì½˜í…ì¸  ìƒì„±"""
    
    def __init__(self, config, db, translator=None):
        self.config = config
        self.db = db
        self.translator = translator
        
        # ë¬´ê¸° â†’ ì „ìŸì‚¬ ë§¤í•‘
        self.weapon_history = {
            # ì „ì°¨
            "k2": {
                "name": "K2 í‘í‘œ",
                "history": [
                    "6.25 ì „ìŸ ë‹¹ì‹œ ë¶í•œ T-34 ì „ì°¨ì— ì†ìˆ˜ë¬´ì±…ìœ¼ë¡œ ë‹¹í•œ êµí›ˆ",
                    "1970ë…„ëŒ€ M48 íŒ¨íŠ¼ ìš´ìš©, ìì£¼ ì „ì°¨ ê°œë°œ í•„ìš”ì„± ëŒ€ë‘",
                    "K1 ì „ì°¨ ê°œë°œ ì„±ê³µ â†’ K2ë¡œ ì§„í™”"
                ],
                "specs": "120mm í™œê°•í¬, 1500ë§ˆë ¥, ìë™ì¥ì „ì¥ì¹˜, ëŠ¥ë™ë°©ì–´ì²´ê³„",
                "stocks": ["í˜„ëŒ€ë¡œí…œ(064350)", "í’ì‚°(103140)"],
                "export": ["í´ë€ë“œ 1000ëŒ€ ê³„ì•½", "ì¤‘ë™ ìˆ˜ì¶œ í˜‘ìƒ ì¤‘"]
            },
            "k9": {
                "name": "K9 ìì£¼í¬",
                "history": [
                    "6.25 ì „ìŸ ì¤‘ í¬ë³‘ í™”ë ¥ì˜ ì¤‘ìš”ì„± ì¸ì‹",
                    "ì—°í‰ë„ í¬ê²©ì „(2010ë…„) - K9 ëŒ€ì‘ ì‚¬ê²©ìœ¼ë¡œ ì£¼ëª©",
                    "ì„¸ê³„ ìì£¼í¬ ì‹œì¥ 1ìœ„ ë“±ê·¹"
                ],
                "specs": "155mm 52êµ¬ê²½ì¥, ì‚¬ê±°ë¦¬ 40km+, ë¶„ë‹¹ 6ë°œ",
                "stocks": ["í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤(012450)", "í’ì‚°(103140)"],
                "export": ["í´ë€ë“œ, í˜¸ì£¼, ì´ì§‘íŠ¸, ì—ìŠ¤í† ë‹ˆì•„ ìˆ˜ì¶œ"]
            },
            "kf-21": {
                "name": "KF-21 ë³´ë¼ë§¤",
                "history": [
                    "F-5 ë„ì…(1965ë…„) ì´í›„ ì „íˆ¬ê¸° êµ­ì‚°í™” ìˆ™ì›",
                    "KF-16 ë©´í—ˆìƒì‚° â†’ T-50 ë…ìê°œë°œ â†’ KF-21 ì™„ì„±",
                    "ì„¸ê³„ 8ë²ˆì§¸ ì´ˆìŒì† ì „íˆ¬ê¸° ë…ìê°œë°œêµ­"
                ],
                "specs": "4.5ì„¸ëŒ€, ë§ˆí•˜ 1.81, AESA ë ˆì´ë”, ìŠ¤í…”ìŠ¤ ì„¤ê³„",
                "stocks": ["í•œêµ­í•­ê³µìš°ì£¼(047810)", "í•œí™”ì‹œìŠ¤í…œ(272210)", "LIGë„¥ìŠ¤ì›(079550)"],
                "export": ["ì¸ë„ë„¤ì‹œì•„ ê³µë™ê°œë°œ", "ë™ë‚¨ì•„/ì¤‘ë™ ìˆ˜ì¶œ ëª©í‘œ"]
            },
            "f-35": {
                "name": "F-35 Lightning II",
                "history": [
                    "F-117 ìŠ¤í…”ìŠ¤ê¸° ê±¸í”„ì „ í™œì•½(1991ë…„)",
                    "ìŠ¤í…”ìŠ¤ ê¸°ìˆ ì´ í˜„ëŒ€ ê³µì¤‘ì „ì˜ í•µì‹¬ìœ¼ë¡œ",
                    "F-22 ìˆ˜ì¶œê¸ˆì§€ â†’ ë™ë§¹êµ­ìš© F-35 ê°œë°œ"
                ],
                "specs": "5ì„¸ëŒ€ ìŠ¤í…”ìŠ¤, ìˆ˜ì§ì´ì°©ë¥™(Bí˜•), ì„¼ì„œ ìœµí•©",
                "stocks": ["ë¡íˆë“œë§ˆí‹´(LMT)", "ë…¸ìŠ¤ë¡­ê·¸ë£¨ë¨¼(NOC)", "í•œí™”ì‹œìŠ¤í…œ(272210)"],
                "export": ["í•œêµ­ 40ëŒ€ ë„ì…", "ì¶”ê°€ 20ëŒ€ í˜‘ìƒ ì¤‘"]
            },
            "drone": {
                "name": "êµ°ìš© ë“œë¡ ",
                "history": [
                    "ë‚˜ê³ ë¥´ë…¸-ì¹´ë¼ë°”í ì „ìŸ(2020ë…„) - ë“œë¡ ì´ ì „ì°¨ ìˆ˜ë°±ëŒ€ ê²©íŒŒ",
                    "ëŸ¬ì‹œì•„-ìš°í¬ë¼ì´ë‚˜ ì „ìŸ - ë“œë¡  ì „ìŸì˜ ë³¸ê²©í™”",
                    "ê¸°ì¡´ ì „ë ¥ êµ¬ì¡°ì˜ íŒ¨ëŸ¬ë‹¤ì„ ì „í™˜"
                ],
                "specs": "ì •ì°°/ê³µê²© ê²¸ìš©, ìí­ë“œë¡ , êµ°ì§‘ë“œë¡ ",
                "stocks": ["í•œí™”ì‹œìŠ¤í…œ(272210)", "ëŒ€í•œí•­ê³µ(003490)", "í•œì»´ì¸ìŠ¤í˜ì´ìŠ¤"],
                "export": ["ì¤‘ë™/ë™ë‚¨ì•„ ìˆ˜ì¶œ ì¶”ì§„"]
            },
            "submarine": {
                "name": "ì ìˆ˜í•¨",
                "history": [
                    "ì²œì•ˆí•¨ í”¼ê²©(2010ë…„) - ëŒ€ì ì „ ëŠ¥ë ¥ ê°•í™” ê³„ê¸°",
                    "ë…ì¼ 209ê¸‰ ë„ì… â†’ ì¥ë³´ê³ ê¸‰ ê±´ì¡° â†’ ë„ì‚°ì•ˆì°½í˜¸ê¸‰",
                    "SLBM ë°œì‚¬ ì„±ê³µìœ¼ë¡œ ì „ëµë¬´ê¸° ë³´ìœ "
                ],
                "specs": "3000í†¤ê¸‰, AIP ì¶”ì§„, SLBM íƒ‘ì¬",
                "stocks": ["í•œí™”ì˜¤ì…˜(042660)", "ëŒ€ìš°ì¡°ì„ í•´ì–‘"],
                "export": ["ì¸ë„ë„¤ì‹œì•„ ìˆ˜ì¶œ"]
            },
            "missile": {
                "name": "ë¯¸ì‚¬ì¼",
                "history": [
                    "ë¶í•œ ìŠ¤ì»¤ë“œ ìœ„í˜‘ â†’ í•œêµ­í˜• ë¯¸ì‚¬ì¼ ê°œë°œ ì‹œì‘",
                    "í˜„ë¬´ ì‹œë¦¬ì¦ˆ ê°œë°œ, ì‚¬ê±°ë¦¬ ì œí•œ í•´ì œ(2021ë…„)",
                    "ê·¹ì´ˆìŒì† ë¯¸ì‚¬ì¼ ê°œë°œ ì§„í–‰ ì¤‘"
                ],
                "specs": "í˜„ë¬´-5: ì‚¬ê±°ë¦¬ 3000km+, íƒ„ë‘ 8í†¤",
                "stocks": ["LIGë„¥ìŠ¤ì›(079550)", "í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤(012450)"],
                "export": ["UAE ì²œê¶-II ìˆ˜ì¶œ"]
            },
            "aircraft carrier": {
                "name": "í•­ê³µëª¨í•¨",
                "history": [
                    "íƒœí‰ì–‘ ì „ìŸ - í•­ëª¨ê°€ í•´ì „ì˜ ì£¼ì—­ìœ¼ë¡œ",
                    "ë¯¸ë“œì›¨ì´ í•´ì „(1942ë…„) - í•­ëª¨ ê¸°ë™ë¶€ëŒ€ì˜ ê²°ì •ì  ì—­í• ",
                    "í•œêµ­ ê²½í•­ëª¨ ì‚¬ì—… ì¶”ì§„ ì¤‘"
                ],
                "specs": "3ë§Œí†¤ê¸‰ ê²½í•­ëª¨, F-35B íƒ‘ì¬ ê³„íš",
                "stocks": ["í•œí™”ì˜¤ì…˜(042660)", "HDí˜„ëŒ€ì¤‘ê³µì—…(329180)"],
                "export": ["ê±´ì¡° ê¸°ìˆ  í™•ë³´ ëª©ì "]
            },
            "hanwha": {
                "name": "í•œí™”ê·¸ë£¹ ë°©ì‚°",
                "history": [
                    "1970ë…„ëŒ€ ë°©ìœ„ì‚°ì—… ìœ¡ì„± ì •ì±…ê³¼ í•¨ê»˜ ì„±ì¥",
                    "í•œí™”ë””íœìŠ¤ + ëŒ€ìš°ì¡°ì„  ì¸ìˆ˜ë¡œ ì¢…í•© ë°©ì‚°ê·¸ë£¹",
                    "K9, ì²œë¬´, ì ìˆ˜í•¨ ë“± ë‹¤ì–‘í•œ í¬íŠ¸í´ë¦¬ì˜¤"
                ],
                "specs": "ì§€ìƒ/í•´ìƒ/í•­ê³µ/ìš°ì£¼ ì „ ë¶„ì•¼",
                "stocks": ["í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤(012450)", "í•œí™”ì‹œìŠ¤í…œ(272210)", "í•œí™”ì˜¤ì…˜(042660)"],
                "export": ["í´ë€ë“œ ëŒ€ê·œëª¨ ê³„ì•½", "ì¤‘ë™ ì§„ì¶œ í™•ëŒ€"]
            },
            "hyundai rotem": {
                "name": "í˜„ëŒ€ë¡œí…œ",
                "history": [
                    "í˜„ëŒ€ìë™ì°¨ ê³„ì—´ ë°©ì‚°/ì² ë„ ì „ë¬¸ê¸°ì—…",
                    "K1, K2 ì „ì°¨ ìƒì‚°",
                    "í´ë€ë“œ K2 ìˆ˜ì¶œë¡œ ê¸€ë¡œë²Œ ë°©ì‚°ê¸°ì—… ë„ì•½"
                ],
                "specs": "K2 ì „ì°¨, ì°¨ë¥œí˜•ì¥ê°‘ì°¨",
                "stocks": ["í˜„ëŒ€ë¡œí…œ(064350)"],
                "export": ["í´ë€ë“œ 1000ëŒ€+", "ì¤‘ë™ í˜‘ìƒ"]
            },
            "poland": {
                "name": "í´ë€ë“œ ë°©ì‚° ìˆ˜ì¶œ",
                "history": [
                    "ëŸ¬ì‹œì•„-ìš°í¬ë¼ì´ë‚˜ ì „ìŸìœ¼ë¡œ í´ë€ë“œ ì•ˆë³´ ìœ„ê¸°ê°",
                    "êµ¬ì†Œë ¨ì œ ì¥ë¹„ êµì²´ í•„ìš”ì„±",
                    "í•œêµ­ì‚° ë¬´ê¸° ëŒ€ê·œëª¨ ë„ì… ê²°ì •"
                ],
                "specs": "K2 ì „ì°¨ 1000ëŒ€, K9 ìì£¼í¬ 600ëŒ€, FA-50 48ëŒ€",
                "stocks": ["í˜„ëŒ€ë¡œí…œ(064350)", "í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤(012450)", "í•œêµ­í•­ê³µìš°ì£¼(047810)"],
                "export": ["ì—­ëŒ€ ìµœëŒ€ ê·œëª¨ ìˆ˜ì¶œ ê³„ì•½"]
            }
        }
        
        logger.info("âœ… ì½˜í…ì¸  ìƒì„±ê¸° ì´ˆê¸°í™”")
    
    def find_related_topics(self, title):
        """ë‰´ìŠ¤ ì œëª©ì—ì„œ ê´€ë ¨ ì£¼ì œ ì°¾ê¸°"""
        title_lower = title.lower()
        matched = []
        
        for keyword, data in self.weapon_history.items():
            if keyword in title_lower:
                matched.append((keyword, data))
        
        return matched
    
    def generate_blog_outline(self, article):
        """ë¸”ë¡œê·¸ ê¸€ ê°œìš” ìƒì„±"""
        title = article.get('title', '')
        title_ko = article.get('title_ko', '')
        url = article.get('url', '')
        source = article.get('source', '')
        
        # ê´€ë ¨ ì£¼ì œ ì°¾ê¸°
        topics = self.find_related_topics(title)
        
        if not topics:
            return None
        
        # ì²« ë²ˆì§¸ ë§¤ì¹­ ì£¼ì œ ì‚¬ìš©
        keyword, data = topics[0]
        
        outline = {
            'news': {
                'title': title,
                'title_ko': title_ko,
                'url': url,
                'source': source
            },
            'weapon': {
                'name': data['name'],
                'specs': data['specs']
            },
            'history': data['history'],
            'investment': {
                'stocks': data['stocks'],
                'export': data['export']
            },
            'generated_at': datetime.now().isoformat()
        }
        
        return outline
    
    def format_blog_post(self, outline):
        """ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥"""
        if not outline:
            return None
        
        news = outline['news']
        weapon = outline['weapon']
        history = outline['history']
        investment = outline['investment']
        
        post = f"""
{'='*60}
ğŸ“° ë¸”ë¡œê·¸ ì½˜í…ì¸  ì´ˆì•ˆ
{'='*60}

## ë‰´ìŠ¤ ì†ŒìŠ¤
- ì›ë¬¸: {news['title']}
- ë²ˆì—­: {news['title_ko'] or '(ë²ˆì—­ ì—†ìŒ)'}
- ì¶œì²˜: {news['source']}
- ë§í¬: {news['url']}

{'â”€'*60}

## ì œëª© ì•„ì´ë””ì–´
1. "{weapon['name']}, ì „ìŸì˜ ì—­ì‚¬ì—ì„œ íˆ¬ì ê¸°íšŒê¹Œì§€"
2. "ë‰´ìŠ¤ë¡œ ë³´ëŠ” {weapon['name']} - ì—­ì‚¬, ì„±ëŠ¥, ìˆ˜í˜œì£¼ ë¶„ì„"
3. "{weapon['name']} ì™„ì „ ì •ë³µ: ì „ìŸì‚¬ë¶€í„° ë°©ì‚°ì£¼ê¹Œì§€"

{'â”€'*60}

## 1ë¶€: ì „ìŸì‚¬ ë°°ê²½ ğŸ–ï¸

"""
        for i, h in enumerate(history, 1):
            post += f"- {h}\n"
        
        post += f"""
{'â”€'*60}

## 2ë¶€: ë¬´ê¸° ë¶„ì„ ğŸ”§

**{weapon['name']}**
- ì£¼ìš” ì œì›: {weapon['specs']}

{'â”€'*60}

## 3ë¶€: íˆ¬ì í¬ì¸íŠ¸ ğŸ“ˆ

**ê´€ë ¨ ì¢…ëª©**
"""
        for stock in investment['stocks']:
            post += f"- {stock}\n"
        
        post += f"""
**ìˆ˜ì¶œ í˜„í™©**
"""
        for exp in investment['export']:
            post += f"- {exp}\n"
        
        post += f"""
{'â”€'*60}

## ê²°ë¡  ì‘ì„± ê°€ì´ë“œ
- ë‰´ìŠ¤ ìš”ì•½
- ì—­ì‚¬ì  ì˜ë¯¸
- íˆ¬ì ì‹œì‚¬ì 
- í–¥í›„ ì „ë§

{'='*60}
"""
        return post
    
    def generate_from_news(self, article):
        """ë‰´ìŠ¤ì—ì„œ ë¸”ë¡œê·¸ ì½˜í…ì¸  ìƒì„±"""
        outline = self.generate_blog_outline(article)
        if outline:
            return self.format_blog_post(outline)
        return None
    
    def process_top_articles(self, limit=5):
        """ìƒìœ„ ê¸°ì‚¬ë“¤ë¡œ ì½˜í…ì¸  ìƒì„±"""
        cursor = self.db.conn.cursor()
        cursor.execute('''
            SELECT id, title, title_ko, url, source, score 
            FROM rss_articles 
            WHERE is_used = 0
            ORDER BY score DESC, created_at DESC 
            LIMIT ?
        ''', (limit,))
        
        articles = cursor.fetchall()
        results = []
        
        for row in articles:
            article = {
                'id': row[0],
                'title': row[1],
                'title_ko': row[2],
                'url': row[3],
                'source': row[4],
                'score': row[5]
            }
            
            content = self.generate_from_news(article)
            if content:
                results.append({
                    'article': article,
                    'content': content
                })
        
        return results